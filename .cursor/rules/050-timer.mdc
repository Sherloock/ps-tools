---
description: Timer module commands and documentation
globs: "core/Timer.ps1,core/TimerHelpers.ps1,core/Helpers.ps1"
---

# Timer Module

The timer module provides background timers with notifications. It's excluded from `??` dashboard and has its own help system.

## Help Access

- `timer` or `t` (without arguments) → shows full timer help dashboard
- `tl` → lists active timers with quick command reference

## Commands & Aliases

| Command | Alias | Description |
|---------|-------|-------------|
| `Timer` | `t` | Start a timer (simple or sequence) |
| `TimerPresets` | `tpre` | Interactive preset picker for sequences |
| `TimerList` | `tl` | List active timers (-a all, -w live watch) |
| `TimerWatch` | `tw` | Watch single timer with progress bar |
| `TimerPause` | `tp` | Pause timer(s) |
| `TimerResume` | `tr` | Resume paused/lost timer(s) |
| `TimerRemove` | `td` | Remove timer(s): id, done (completed/lost), all |

## Time Format

Accepts: `1h30m`, `25m`, `90s`, `1h20m30s`

## Sequence Timer Syntax

Complex timer sequences (Pomodoro-style) use this syntax:

```
(duration label, duration label)xN
```

**Examples:**
- `t pomodoro` - Use preset
- `t "(25m work, 5m rest)x4"` - 4 work/rest cycles
- `t "(50m focus, 10m break)x3, 30m 'long break'"` - 3 cycles + break
- `t "((25m work, 5m rest)x4, 20m break)x2"` - Nested: 2 full sets

**Built-in Presets** (configurable in `config.ps1`):
- `pomodoro` - Classic: 4x(25m work + 5m rest) + 20m break
- `pomodoro-short` - Quick: 2x(25m work + 5m rest)
- `pomodoro-long` - Extended: 3x(50m work + 10m rest) + 30m break
- `52-17` - Science-backed: 3x(52m focus + 17m break)
- `90-20` - Ultradian: 2x(90m deep + 20m rest)

Custom presets can be added via `$Config.TimerPresets` - see `config.example.ps1`.

## Implementation Notes

- Timers use **Windows Scheduled Tasks** (survive terminal closure)
- Timer state persists in `$env:TEMP\ps-timers.json`
- Tasks named: `PSTimer_<id>`, scripts at `$env:TEMP\PSTimer_<id>.ps1`
- Notification script runs independently, updates JSON, handles repeats/phases

### Helper Files

**`Helpers.ps1`** (general):
- `ConvertTo-Seconds`, `Format-Duration`, `New-TimerId`
- `Get-TimerData`, `Save-TimerData`, `Sync-TimerData`
- `Start-TimerJob`, `Stop-TimerTask`, `Show-MenuPicker`

**`TimerHelpers.ps1`** (timer-specific):
- `Get-AnsiColors`, `Format-RemainingTime`, `Get-TimerStateColor`
- `Get-TimerProgress`, `Get-TruncatedMessage`, `Get-TimerPickerOptions`
- Sequence helpers: `Test-TimerSequence`, `ConvertFrom-TimerSequence`, `ParseSequence`, `Expand-TimerSequence`, `Get-SequenceSummary`
- `Start-SequenceTimerJob`
- `$script:TimerPresets` (merged from config + defaults)

## Timer Data Model

Standard timer fields:
- `Id`, `Duration`, `Seconds`, `Message`
- `StartTime`, `EndTime`, `State`
- `RepeatTotal`, `RepeatRemaining`, `CurrentRun`
- `RemainingSeconds` (for paused timers)
- `IsSequence` (bool)

Sequence-specific fields (when `IsSequence = $true`):
- `SequencePattern` - Original pattern string
- `Phases` - Array of phase objects with: Seconds, Label, Duration, LoopId, LoopIteration, LoopTotal
- `CurrentPhase` - Index of current phase (0-based)
- `TotalPhases` - Total number of phases
- `PhaseLabel` - Current phase label
- `TotalSeconds` - Total duration of entire sequence

## Timer States

- `Running` - Active timer with scheduled task
- `Paused` - Temporarily paused, can resume with remaining time
- `Completed` - Finished successfully
- `Lost` - Task not found after end time (can be restarted with `tr`)

## Interactive Display (Anti-Flicker)

When printing interactive/updating displays (menus, watch modes, progress):
- Build entire output in a `StringBuilder` before printing
- Use `[Console]::Write($sb.ToString())` for atomic output
- Clear screen AFTER building output, immediately before writing
- Use ANSI escape codes (from `Get-AnsiColors`) instead of multiple `Write-Host` calls

## When Adding Timer Features

1. User-facing functions go in `Timer.ps1`
2. Timer-specific helpers go in `TimerHelpers.ps1`
3. General helpers go in `Helpers.ps1`
4. Update the `Show-TimerHelp` function if adding new commands
5. Add alias in the aliases section of `Timer.ps1`
6. Update this rule file (`050-timer.mdc`) with new documentation
7. Write tests in `tests/Timer.Tests.ps1` or `tests/Core.Tests.ps1`
